---
title: 'Reproducible Research: Peer Assessment 2'
author: "Katya Demidova"
date: "24 December 2015"
output: html_document
---

## Synopsis

The goal of this project is to analyze how severe weather events affect public health and economy of the United States. Our research addresses two main questions:

1. which types of events are most harmful with respect to population health?

2. which types of events have the greatest economic consequences?

We have found out that tornadoes are significantly more harmful to population health than any other type of events; floods, lightnings, excessive heat and thunderstorm winds cause many injuries and fatalities as well.

Floods, hurricane typhoons, tornadoes, and storm surges cause most property damage (40-140 $ billions). And the most harmful for crops are drought, floods, and ice storms. 
Summing up, tornadoes and floods cause dramatically huge public health and economic problems for communities and municipalities, and preventing such outcomes to the extent possible is a key concern.

## Data

The data for this assignment (comma-separated-value file compressed via the bzip2 algorithm):

* [Storm Data][1] [47Mb]

Documentation of the database:

* National Weather Service [Storm Data Documentation][2]
* National Climatic Data Center Storm Events [FAQ][3]

[1]: https://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2
[2]: https://d396qusza40orc.cloudfront.net/repdata%2Fpeer2_doc%2Fpd01016005curr.pdf
[3]: https://d396qusza40orc.cloudfront.net/repdata%2Fpeer2_doc%2FNCDC%20Storm%20Events-FAQ%20Page.pdf

The events in the database start in the year 1950 and end in November 2011. In the earlier years of the database there are generally fewer events recorded, most likely due to a lack of good records. More recent years should be considered more complete.

## Setting up

```{r, results='hide'}
echo = TRUE # to ensure that all code will be shown

options(scipen = 1)

library(dplyr)
library(tidyr)
library(ggplot2)
library(data.table)
library(R.utils)
library(knitr)
```

## Import the data

The CSV file is very large (561.6 MB), so to load the data for the first time we use `fread()` method. In R Documentation `fread {data.table}` is described as similar to `read.table` but faster and more convenient.

After reading in the original CSV file, we save the dataset as an RDS file so we could restore the dataset via `readRDS()`. `readRDS()` is considered faster than other `read` methods.

The following chunk of code checks if there is an RDS file (if there isn't, it creates it (from the CSV file which is created by unpacking the BZ2 package)) and loads the data into workspace.

```{r, cache=TRUE, results='hide'}
# Download and import the data

if (!file.exists("StormData.rds")) {
  # If we don't have the csv, we need to unpack the .bz2 file
  if (!file.exists("StormData.csv")) {
    # If we don't have the .bz2 file, we need to download it
    if (!file.exists("StormData.csv.bz2")) {
      download.file("https://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2",
                    "StormData.csv.bz2")
    }
    bunzip2("StormData.csv.bz2")
  }
  raw.storm <- fread("StormData.csv", na.strings = c("NA", ""))
  saveRDS(storm, "StormData.rds")
  file.remove("StormData.csv")
}

# Load the data into workspace unless we it already exists
if (!exists("raw.storm")) {
  raw.storm <- readRDS("StormData.rds")
}

```

## Data Processing

Quick overview of the internal structure of the dataset and its first three rows:

```{r, cache=TRUE}
str(raw.storm)
head(raw.storm, n = 3)
```

There are 37 columns and 902297 rows in this dataset.

```{r, cache=TRUE}
dim(raw.storm)
names(raw.storm)
```

Since these column names are not obvious, I've made an attempt to explain these variables. You can see the results in [this table](https://github.com/demidovakatya/repdata-peer-assessment-2/blob/master/variable_explanation.md).

These variables may be useful for further analysis:

Variable name | Class | Explanation
--------------|-------|------------
BGN_DATE | chr | Date when the event began
STATE | chr | State where the event happened
EVTYPE | chr | Event type
FATALITIES | num | Number of fatalities caused by the event
INJURIES | num | Number of injuries caused by the event
PROPDMG | num | Property damage caused by the event
PROPDMGEXP | chr | Property damage multiplier
CROPDMG | num | Crops damage caused by the event
CROPDMGEXP | chr | Crops damage multiplier

Create a new dataset from these columns:

```{r, cache=TRUE}
columns <- c("BGN_DATE", "STATE", "EVTYPE", "FATALITIES", "INJURIES", "PROPDMG", "CROPDMG", "PROPDMGEXP", "CROPDMGEXP")
storm <- select(tbl_df(raw.storm), one_of(columns))

colnames(storm) <- tolower(colnames(storm))

# rm(raw.storm, columns)
```
Event Types Available: 

1. Tornado: From 1950 through 1954, only tornado events were recorded.

2. Tornado, Thunderstorm Wind and Hail: From 1955 through 1992, only tornado, thunderstorm wind and hail events were keyed from the paper publications into digital data. From 1993 to 1995, only tornado, thunderstorm wind and hail events have been extracted from the Unformatted Text Files.

3. All Event Types: From 1996 to present, 48 event types are recorded as defined in NWS Directive 10-1605. ([source](https://www.ncdc.noaa.gov/stormevents/details.jsp))

*Raw list of these event types is located [here](https://gist.github.com/demidovakatya/8bd24a471d36def5971e).* 

From this information, we can conclude that years 1950-1995 should be removed from the data set, otherwise the analysis can be incorrect.

```{r}
# convert bgn_date to date format
storm$bgn_date <- as.Date(storm$bgn_date, format = "%m/%d/%Y %H:%M:%S")

# subset only new data
storm <- subset(storm, bgn_date > as.Date("1996-01-01"))
```

Convert multipliers in `propdmgexp` and `cropdmgexp` columns into numeric values and apply these multipliers:

```{r, cache=TRUE}

storm$propdmgexp <- toupper(storm$propdmgexp)
storm$propdmgexp[storm$propdmgexp == "0"] <- 1
storm$propdmgexp[storm$propdmgexp == "K"] <- 1000
storm$propdmgexp[storm$propdmgexp == "M"] <- 1000000
storm$propdmgexp[storm$propdmgexp == "B"] <- 1000000000
storm$propdmgexp <- as.numeric(storm$propdmgexp)
storm <- storm %>% mutate(propdmg=propdmg * propdmgexp)

storm$cropdmgexp <- toupper(storm$cropdmgexp)
storm$cropdmgexp[storm$cropdmgexp == "0"] <- 1
storm$cropdmgexp[storm$cropdmgexp == "K"] <- 1000
storm$cropdmgexp[storm$cropdmgexp == "M"] <- 1000000
storm$cropdmgexp[storm$cropdmgexp == "B"] <- 1000000000
storm$cropdmgexp <- as.numeric(storm$cropdmgexp)


storm <- storm %>% mutate(cropdmg=cropdmg * cropdmgexp)

# Remove ~dmgexp columns
storm <- storm %>% select(-ends_with("dmgexp"))
```

Convert `state` into factor variable:

```{r, cache=TRUE}
storm$state <- as.factor(storm$state)
```

The last thing is to tidy up the `evtype` column.  Let's save it to a separate variable and then have a look at it:
```{r, cache=TRUE}
events <- storm$evtype
head(data.frame(table(events)), n=20)
```

There are hundreds of different event types due to similar values like these:
- "Freezing rain"
- "Freezing Rain"
- "FREEZING RAIN"

or 

- BLOW OUT TIDE 
- BLOW OUT TIDES

But as we have mentioned before, there are only 48 types of weather events. So, I'll convert all values in `evtype` column to uppercase strings, trim them, and delete punctuation and digits.

```{r}


# trim, clean from punctuation
events <- toupper(events)
events <- gsub("[[:digit:]]+", "", events)
events <- gsub("&", " AND ", events)
events <- gsub("[[:punct:]]+", " ", events)
events <- gsub("^\\s+|\\s+$|\\s\\s+", "", events)

# replace some values
events[events=="TSTM WIND" | events=="THUNDERSTORM" |
      events=="THUNDERSTORM WINDG" | events=="THUNDERSTORMS"] <- "THUNDERSTORM WIND"
events[events=="MARINE TSTM WIND"] <- "MARINE THUNDERSTORM WIND"
events[grep(events, "SUMMARY")] 

events <- data.frame(events)

```



## Results

There are two questions to be answered in the assignment:

1. Across the United States, which types of events are most harmful with respect to population health?
2. Across the United States, which types of events have the greatest economic consequences?


### Most harmful to population health events

```{r, fig.height=8, fig.width=10}
dangerous.events <- storm %>% group_by(evtype) %>% 
  summarise(fatalities=sum(fatalities), injuries=sum(injuries)) %>% 
  top_n(15, wt = fatalities + injuries)

ggplot(data = dangerous.events, aes(evtype, fatalities + injuries)) + 
  geom_bar(stat = "identity") + coord_flip() + 
  xlab("Event type") + ggtitle("15 events causing most harm to population health") 
```
### Events causing most fatalities:
```{r}
storm %>% group_by(evtype) %>% 
  summarise(fatalities=sum(fatalities)) %>% 
  top_n(15, wt = fatalities) %>% 
  arrange(desc(fatalities))

```
### Events causing most injuries:
```{r}
storm %>% group_by(evtype) %>% 
  summarise(injuries=sum(injuries)) %>% 
  top_n(15, wt = injuries) %>% 
  arrange(desc(injuries))

```

### Events causing most property damage:
```{r, fig.height=8, fig.width=10}
property.damage.events <- storm %>% group_by(evtype) %>%
  summarise(property.damage=sum(propdmg)) %>% 
  top_n(15, wt = property.damage) %>% 
  arrange(desc(property.damage))

property.damage.events

ggplot(aes(evtype, property.damage/10^9, fill=evtype), data=property.damage.events) + geom_bar(stat="identity") + xlab("Event type")+ ylab("Property damage cost ($ billions)") + ggtitle("15 events causing most property damage") + theme(axis.text.x = element_text(angle = 90, hjust = 1)) + coord_flip()
```

### Events causing most crop damage:
```{r, fig.height=8, fig.width=10}
crop.damage.events <- storm %>% group_by(evtype) %>% 
  summarise(crop.damage=sum(cropdmg)) %>% 
  top_n(15, wt = crop.damage) %>% 
  arrange(desc(crop.damage))

crop.damage.events

ggplot(aes(evtype, crop.damage/10^9, fill=evtype), data=crop.damage.events) + geom_bar(stat="identity") + xlab("Event type")+ ylab("Crop damage cost ($ billions)") + ggtitle("15 events causing most crop damage") + theme(axis.text.x = element_text(angle = 90, hjust = 1)) + coord_flip()

```
