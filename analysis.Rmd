---
title: 'Reproducible Research: Peer Assessment 2'
author: "Katya Demidova"
date: "28 November 2015"
output: html_document
---

## Synopsis

The goal of this project is to analyze how severe weather events affect public health and economy of the United States. Our research addresses two main questions:

1. which types of events are most harmful with respect to population health?

2. which types of events have the greatest economic consequences?

We have found out that tornadoes are significantly more harmful to population health than any other type of events; floods, lightnings, excessive heat and thunderstorm winds cause many injuries and fatalities as well.

Floods, hurricane typhoons, tornadoes, and storm surges cause most property damage (40-140 $ billions). And the most harmful for crops are drought, floods, and ice storms. 
Summing up, tornadoes and floods cause dramatically huge public health and economic problems for communities and municipalities, and preventing such outcomes to the extent possible is a key concern.

## Data

The data for this assignment (comma-separated-value file compressed via the bzip2 algorithm):

* [Storm Data][1] [47Mb]

Documentation of the database:

* National Weather Service [Storm Data Documentation][2]
* National Climatic Data Center Storm Events [FAQ][3]

[1]: https://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2
[2]: https://d396qusza40orc.cloudfront.net/repdata%2Fpeer2_doc%2Fpd01016005curr.pdf
[3]: https://d396qusza40orc.cloudfront.net/repdata%2Fpeer2_doc%2FNCDC%20Storm%20Events-FAQ%20Page.pdf

The events in the database start in the year 1950 and end in November 2011. In the earlier years of the database there are generally fewer events recorded, most likely due to a lack of good records. More recent years should be considered more complete.

## Setting up

```{r, results='hide'}
echo = TRUE # to ensure that all code will be shown

options(scipen = 1)

library(dplyr)
library(tidyr)
library(ggplot2)
library(data.table)
library(R.utils)
library(knitr)
```

## Import the data

The CSV file is very large (561.6 MB), so to load the data for the first time we use `fread()` method. In R Documentation `fread {data.table}` is described as similar to `read.table` but faster and more convenient.

After reading in the original CSV file, we save the dataset as an RDS file so we could restore the dataset via `readRDS()`. `readRDS()` is considered faster than other `read` methods.

The following chunk of code checks if there is an RDS file (if there isn't, it creates it (from the CSV file which is created by unpacking the BZ2 package)) and loads the data into workspace.

```{r, cache=TRUE, results='hide'}
# Download and import the data

if (!file.exists("StormData.rds")) {
  # If we don't have the csv, we need to unpack the .bz2 file
  if (!file.exists("StormData.csv")) {
    # If we don't have the .bz2 file, we need to download it
    if (!file.exists("StormData.csv.bz2")) {
      download.file("https://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2",
                    "StormData.csv.bz2")
    }
    bunzip2("StormData.csv.bz2")
  }
  raw.storm <- fread("StormData.csv", na.strings = c("NA", ""))
  saveRDS(storm, "StormData.rds")
  file.remove("StormData.csv")
}

# Load the data into workspace unless we it already exists
if (!exists("raw.storm")) {
  raw.storm <- readRDS("StormData.rds")
}

```

## Data Processing

Quick overview of the internal structure of the dataset and its first three rows:

```{r, cache=TRUE}
str(raw.storm)
head(raw.storm, n = 3)
```

There are 37 columns and 902297 rows in this dataset.

```{r, cache=TRUE}
dim(raw.storm)
names(raw.storm)
```

Since these column names are not obvious, I've made an attempt to explain these variables. You can see the results in [this table](https://github.com/demidovakatya/repdata-peer-assessment-2/blob/master/variable_explanation.md).

These variables may be useful for further analysis:

Variable name | Class | Explanation
--------------|-------|------------
BGN_DATE | chr | Date when the event began
STATE | chr | State where the event happened
EVTYPE | chr | Event type
FATALITIES | num | Number of fatalities caused by the event
INJURIES | num | Number of injuries caused by the event
PROPDMG | num | Property damage caused by the event
PROPDMGEXP | chr | Property damage multiplier
CROPDMG | num | Crops damage caused by the event
CROPDMGEXP | chr | Crops damage multiplier

Create a new dataset from these columns:

```{r, cache=TRUE}
columns <- c("BGN_DATE", "STATE", "EVTYPE", "FATALITIES", "INJURIES", "PROPDMG", "CROPDMG", "PROPDMGEXP", "CROPDMGEXP")
storm <- select(tbl_df(raw.storm), one_of(columns))

colnames(storm) <- tolower(colnames(storm))

rm(raw.storm, columns)
```

Convert multipliers in `propdmgexp` and `cropdmgexp` columns into numeric values:

```{r, cache=TRUE}
# A helper function is needed here
storm$propdmgexp <- toupper(storm$propdmgexp)
storm$cropdmgexp <- toupper(storm$cropdmgexp)

# multiplier <- 
storm$propdmgexp[storm$propdmgexp=="B"] <- 9
storm$propdmgexp[storm$propdmgexp=="M"] <- 6
storm$propdmgexp[storm$propdmgexp=="K"] <- 3
storm$propdmgexp[storm$propdmgexp=="H"] <- 2
storm$propdmgexp[storm$propdmgexp=="?" | storm$propdmgexp=="+" | storm$propdmgexp=="-"] <- 0
storm$propdmgexp[is.na(storm$propdmgexp)] <- 0
storm$propdmgexp <- as.numeric(storm$propdmgexp)

storm$cropdmgexp[storm$cropdmgexp=="B"] <- 9
storm$cropdmgexp[storm$cropdmgexp=="M"] <- 6
storm$cropdmgexp[storm$cropdmgexp=="K"] <- 3
storm$cropdmgexp[storm$cropdmgexp=="H"] <- 2
storm$cropdmgexp[storm$cropdmgexp=="?" | storm$cropdmgexp=="+" | storm$cropdmgexp=="-"] <- 0
storm$cropdmgexp[is.na(storm$cropdmgexp)] <- 0
storm$cropdmgexp <- as.numeric(storm$cropdmgexp)

```

Apply the multipliers:

```{r, cache=TRUE}
storm <- storm %>% mutate(propdmg=propdmg * 10 ^ propdmgexp)
# storm <- storm %>% mutate(propdmg=propdmg * multiplier[propdmgexp])
storm <- storm %>% mutate(cropdmg=cropdmg * 10 ^ cropdmgexp)

# Remove ~dmgexp columns
storm <- storm %>% select(-ends_with("dmgexp"))
```

Convert `state` into factor variable:

```{r, cache=TRUE}
storm$state <- as.factor(storm$state)
```

Convert dates:
```{r, cache=TRUE}
storm$bgn_date <- as.Date(storm$bgn_date, format = "%m/%d/%Y %H:%M:%S")
```

The last thing is to tidy up the `evtype` column. Let's save it to a separate variable and then have a look at it:
```{r, cache=TRUE}
head(data.frame(table(storm$evtype)), n=20)
```

We can see similar values, for example:
- "Freezing rain"
- "Freezing Rain"
- "FREEZING RAIN"
- "FREEZING RAIN AND SLEET"

or:
- "HIGH WIND/SEAS"
- "HIGH WIND/WIND CHILL"
- "HIGH WIND/WIND CHILL/BLIZZARD" 
- "HIGH WINDS"
- "HIGH WINDS 55"
- "HIGH WINDS 57"
- "HIGH WINDS 58"
- "HIGH WINDS 63"
- "HIGH WINDS 66"                 
- "HIGH WINDS 67".

From my point of view, these values may be considered equal. So, I'll convert all values in `evtype` column to uppercase strings, trim them, and delete punctuation and digits.

```{r}
storm$evtype <- toupper(storm$evtype)
storm$evtype <- gsub("[[:digit:]]+", "", storm$evtype)
storm$evtype <- gsub("&", " AND ", storm$evtype)
storm$evtype <- gsub("[[:punct:]]+", " ", storm$evtype)
storm$evtype <- gsub("^\\s+|\\s+$|\\s\\s+", "", storm$evtype)

storm$evtype <- as.factor(storm$evtype)
```

Now we still have things like `AVALANCHE` and `AVALANCE`, but we their input in insignificant.

## Results

There are two questions to be answered in the assignment:

1. Across the United States, which types of events are most harmful with respect to population health?
2. Across the United States, which types of events have the greatest economic consequences?

To begin with, I'll create a table containing data summarized by event type:

```{r}
storm <- tbl_df(storm)
event.types <- storm %>% group_by(evtype) %>% 
  summarise(fatalities = sum(fatalities), injuries = sum(injuries),
            propdmg = sum(propdmg), cropdmg = sum(cropdmg))

kable(head(event.types, n = 10))
```

### Events causing most fatalities:
```{r, fig.height=8, fig.width=10}
dangerous.events <- storm %>% group_by(evtype) %>% 
  summarise(fatalities=sum(fatalities), injuries=sum(injuries)) %>% 
  top_n(15, wt = fatalities + injuries)

# ggplot(aes(evtype, fatalities, fill = fatalities), data = fatality.events) + 
#   geom_bar(stat = "identity") + xlab("Event type") + ggtitle("15 events causing most fatalities") + scale_fill_continuous(low="red", high="black") + theme(axis.text.x = element_text(angle = 90, hjust = 1), legend.position="none")
```

### Events causing most injuries:
```{r, fig.height=8, fig.width=10}
injury.events <- storm %>% group_by(evtype) %>% 
  summarise(injuries=sum(injuries)) %>% 
  top_n(15, wt = injuries) %>% 
  arrange(desc(injuries))

kable(injury.events)

ggplot(aes(evtype, injuries, fill = injuries), data = injury.events) + geom_bar(stat = "identity") + xlab("Event type") + ggtitle("15 events causing most injuries") + scale_fill_continuous(low="blue", high="black") + theme(axis.text.x = element_text(angle = 90, hjust = 1), legend.position="none")

```

### Events causing most property damage:
```{r, fig.height=8, fig.width=10}
property.damage.events <- storm %>% group_by(evtype) %>%
  summarise(property.damage=sum(propdmg)) %>% 
  top_n(15, wt = property.damage) %>% 
  arrange(desc(property.damage))

kable(property.damage.events)

ggplot(aes(evtype, property.damage/10^9, fill=evtype), data=property.damage.events) + geom_bar(stat="identity") + xlab("Event type")+ ylab("Property damage cost ($ billions)") + ggtitle("15 events causing most property damage") + theme(axis.text.x = element_text(angle = 90, hjust = 1)) + coord_flip()
```

### Events causing most crop damage:
```{r, fig.height=8, fig.width=10}
crop.damage.events <- storm %>% group_by(evtype) %>% 
  summarise(crop.damage=sum(cropdmg)) %>% 
  top_n(15, wt = crop.damage) %>% 
  arrange(desc(crop.damage))

kable(crop.damage.events)

ggplot(aes(evtype, crop.damage/10^9, fill=evtype), data=crop.damage.events) + geom_bar(stat="identity") + xlab("Event type")+ ylab("Crop damage cost ($ billions)") + ggtitle("15 events causing most crop damage") + theme(axis.text.x = element_text(angle = 90, hjust = 1)) + coord_flip()

```
